"use strict";function getWaypointByName(e){for(var s=0;s<DATA.waypointsMsg.waypoints.length;s++){var t=DATA.waypointsMsg.waypoints[s];if(t.name===e)return t}}function getTrajectoryByName(e){for(var s,t=0;t<DATA.trajectoriesMsg.trajectories.length&&(s=DATA.trajectoriesMsg.trajectories[t]).name!==e;t++);return s}function isNameUsed(e){if(DATA.waypointsMsg)for(s=0;s<DATA.waypointsMsg.waypoints.length;s++)if(DATA.waypointsMsg.waypoints[s].name===e)return!0;if(DATA.trajectoriesMsg)for(var s=0;s<DATA.trajectoriesMsg.trajectories.length;s++)if(DATA.trajectoriesMsg.trajectories[s].name===e)return!0;return!1}var PARAMS=PARAMS||{DefaultPose:{position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:1}},CmdVel:.05,SailDis:.3,DockingBeginDis:.35,PowerWarnThreshold:.2,ChargeStatus:{uncontact:0,contact:1,volAbnormal:2,charging:3},NavCtrl:{stop:0,start:1,pause:2},NavCtrlStatus:{error:-1,idling:0,running:1,paused:2,completed:3,cancelled:4,sub_cancelled:5},NetworkMode:{ap:"ap",wifi:"wifi"},RobotStatus:{MappingStatus:"mappingStatus",LastNetworkSetting:"lastNetworkSetting"},Extensions:["ster","ster2","tofflon"],DiagnosticsLevel:{Warn:1,Error:2,Stale:3},NeedPoseTypes:["goal","pallet","mark","initial_pose"]},NAV=NAV||{CmdEnum:{Navigation:"navigation",Gmapping:"gmapping",Cancel:"cancel",Converting:"converting",GamppingPose:"gmapping_pose",SaveMap:"save_map",SaveMapEdit:"save_map_edit",SaveAsMap:"save_as_map",SaveAsMapEdit:"save_as_map_edit",LoadMap:"load_map",LoadMapEdit:"load_map_edit",Userauth:"user_auth",MapSelect:"dbparam-select",MapDelete:"dbparam-delete",MapUpdate:"dbparam-update",MapInsert:"dbparam-insert",Update:"update",RoslogDelete:"roslog-delete",RoslogSelect:"roslog-select",Version:"version"},RosMode:{Gmapping:"gmapping",Navigation:"navigation",Converting:"converting"},WaypointMode:{Map:"map",Timer:"timer",Puber:"publisher",Suber:"subscriber",Pubsuber:"pubsuber",Looper:"looper",CmdVelSetSub:"cmd_vel_set_sub",CmdVel:"cmd_vel",Shell:"shell",SoundPlay:"sound_play",InitialPose:"initial_pose",ScanMaker:"scan_marker",ShellString:"shell_string",Pallet:"pallet"},SoundPlayMode:{Stop:"STOP",Start:"START",Once:"ONCE"},WaypointPrefix:{goal:"goal",timer:"timer",publisher:"pub",subscriber:"sub",looper:"loop",pubsuber:"pubsuber",cmd_vel_set_sub:"velSet",cmd_vel:"vel",shell:"shell",sound_play:"sound",initial_pose:"pose",scan_marker:"scanMarker",shell_string:"shellStr",pallet:"pallet"},ManualCtrlVel:{linear:.4,angular:.8},init:function(e){NAV.ros=new ROSLIB.Ros,NAV.ros.connect(e),NAV.ros.on("connection",function(){console.log("[INFO]Connected to rosbridge "+e+"."),DATA.ros=NAV.ros}),NAV.ros.on("close",function(){console.log("[INFO]Rosbridge server "+e+" closed."),ALERT.error({title:"网络错误",text:"Rosbridge连接失败"})}),NAV.ros.on("error",function(){console.error("[ERROR]Connection error.")})},withNs:function(e){var s=e.startsWith("/")?e:"/"+e;return"undefined"===DATA.namespace?s:DATA.namespace.startsWith("/")?DATA.namespace+s:"/"+DATA.namespace+s},getRobotStatus:function(){for(var e=arguments.length,s=Array(e),t=0;t<e;t++)s[t]=arguments[t];var a=new ROSLIB.Service({ros:NAV.ros,name:NAV.withNs("/rosnodejs/robot_status"),serviceType:"rosapi/Publishers"});if(0===s.length)r=new ROSLIB.ServiceRequest({topic:""});else{for(var o="",n=0;n<s.length;n++)o+=s[n]+", ";var r=new ROSLIB.ServiceRequest({topic:o})}a.callService(r,function(e){for(var s=0;s<e.publishers.length;s++){var t=e.publishers[s].split(":")[0].trim(),a=e.publishers[s].split(":")[1].trim();switch(t){case PARAMS.RobotStatus.MappingStatus:DATA.mappingStatus=a;break;case PARAMS.RobotStatus.LastNetworkSetting:DATA.lastNetworkSetting=a}}})},dispMapAndWps:function(e,s){var t=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs(e),messageType:"nav_msgs/OccupancyGrid"});s&&(DATA.useBase64=!0,t=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("map_stream"),messageType:"scheduling_msgs/MapStream"})),DATA.topic.mapTopic=t,t.subscribe(function(e){DATA.mapMsg=e,console.log(e),NAV.dispWaypoints()})},dispWaypoints:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/waypoints"),messageType:"yocs_msgs/WaypointList"});DATA.topic.waypointsTopic=e,e.subscribe(function(e){console.log("[INFO]Got waypoints"),DATA.waypointsMsg=e})},dispTrajectories:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/trajectories"),messageType:"yocs_msgs/TrajectoryList"}).subscribe(function(e){console.log("[INFO]Got trajectories."),DATA.trajectoriesMsg=e})},dispRobot:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/robot_pose"),messageType:"geometry_msgs/Pose"});DATA.topic.robotPoseTopic=e,e.subscribe(function(e){DATA.robotPoseMsg=e})},dispGlobalPlan:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/move_base/NavfnROS/plan"),messageType:"nav_msgs/Path"});DATA.topic.globalPlanTopic=e,e.subscribe(function(e){DATA.globalPlanMsg=e})},dispLocalPlan:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/move_base/DWAPlannerROS/local_plan"),messageType:"nav_msgs/Path"});DATA.topic.localPlanTopic=e,e.subscribe(function(e){DATA.localPlanMsg=e})},dispFootprint:function(e){var s=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs(e||"/move_base/global_costmap/footprint"),messageType:"geometry_msgs/PolygonStamped"});DATA.topic.footprintTopic=s,s.subscribe(function(e){DATA.footprintMsg=e})},dispLaserScan:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/scan_rectified"),messageType:"sensor_msgs/LaserScan",throttle_rate:200});DATA.topic.laserScanTopic=e,e.subscribe(function(e){DATA.laserScanMsg=e})},dispLocalCostmap:function(){var e=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/move_base/local_costmap/costmap"),messageType:"nav_msgs/OccupancyGrid"});DATA.topic.localCostmapTopic=e,e.subscribe(function(s){e.unsubscribe()})},listenTf:function(e){if(e=void 0===e||e){var s=new ROSLIB.TFClient({ros:NAV.ros,fixedFrame:"map",angularThres:.01,transThres:.01});s.subscribe("odom",function(e){DATA.tfMsg.map2odom={header:{stamp:null},transform:e}}),s.subscribe("base_footprint",function(e){DATA.tfMsg.map2base_footprint={header:{stamp:null},transform:e}}),s.subscribe("base_laser",function(e){DATA.tfMsg.map2base_laser={header:{stamp:null},transform:e}}),new ROSLIB.TFClient({ros:NAV.ros,fixedFrame:"base_link",angularThres:.01,transThres:.01}).subscribe("base_laser",function(e){DATA.tfMsg.base_link2base_laser={header:{stamp:null},transform:e}})}else new ROSLIB.Topic({ros:NAV.ros,name:"/tf",messageType:"tf2_msgs/TFMessage"}).subscribe(function(e){for(var s=0;s<e.transforms.length;s++){var t=e.transforms[s].header.frame_id,a=e.transforms[s].child_frame_id;t.startsWith("/")&&(t=t.split("/")[1]),a.startsWith("/")&&(a=a.split("/")[1]);var o=t+"2"+a;DATA.tfMsg[o]=e.transforms[s]}})},sendInitialPose:function(e){for(var s=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/initialpose"),messageType:"geometry_msgs/PoseWithCovarianceStamped"}),t=[],a=0;a<36;a++)t[a]=0;t[0]=.25,t[7]=.25,t[35]=Math.pow(Math.PI/12,2);var o=new ROSLIB.Message({header:{frame_id:"map"},pose:{pose:e,covariance:t}});s.publish(o),console.log("[INFO]setting initial pose")},subShellFeedback:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/shell_feedback"),messageType:"std_msgs/String"}).subscribe(function(e){switch(e.data){case"":break;default:var s=e.data.split(/[ :]/);switch(s[0].trim()){case"dbparam":DATA.mapList=s.slice(1);break;case"update":"update"===DATA.loading.key&&(DATA.loading=!1),"success"===s[1].trim()?ALERT.info({title:"软件更新",text:"更新成功"}):ALERT.error({title:"软件更新",text:"更新失败"})}}})},subDiagnostics:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/diagnostics_agg"),messageType:"diagnostic_msgs/DiagnosticArray"}).subscribe(function(e){for(var s=0;s<e.status.length;s++)"/Other/ros_mode"===e.status[s].name&&(DATA.rosMode=e.status[s].message)})},subRosMode:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/ros_mode"),messageType:"std_msgs/String"}).subscribe(function(e){DATA.mappingStatus=e.data})},subMappingStatus:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/rosnodejs/mappingStatus"),messageType:"std_msgs/String"}).subscribe(function(e){DATA.mappingStatus=e.data,e.data===NAV.CmdEnum.SaveMap&&setTimeout(function(){NAV.saveMapEdit()},5e3)})},subNavCtrlStatus:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/nav_ctrl_status"),messageType:"yocs_msgs/NavigationControlStatus"}).subscribe(function(e){DATA.navCtrlStatus=e})},subWaypointUserSub:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/waypoint_user_sub"),messageType:"std_msgs/String"}).subscribe(function(e){var s=e.data.indexOf(":"),t=e.data.substr(0,s).trim(),a=e.data.substring(s+1).trim();switch(t){case"read_status":DATA.plcStatus=a}})},subRobotStatus:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/rosnodejs/robot_status"),messageType:"std_msgs/String"}).subscribe(function(e){var s=e.data.indexOf(":"),t=e.data.substr(0,s).trim(),a=e.data.substring(s+1).trim();switch(t){case"power":var o=parseFloat(a);DATA.powerStatus!==o&&(DATA.powerStatus=o);break;case"charge":var n=parseInt(a);DATA.chargeStatus!==n&&(DATA.chargeStatus=n);break;case"diagnostics":var r=JSON.parse(a);DATA.diagnosticsMsg=r}})},cmdStringTopic:function(){return new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/cmd_string"),messageType:"std_msgs/String"})},waypointUserPubTopic:function(){return new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/waypoint_user_pub"),messageType:"std_msgs/String"})},pubCmdString:function(e){var s=NAV.cmdStringTopic(),e=new ROSLIB.Message({data:e});s.publish(e)},pubMapEditObstacle:function(e){var s=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/map_edit_obstacle"),messageType:"geometry_msgs/Polygon"}),t=new ROSLIB.Message({points:e});s.publish(t)},saveMap:function(){console.log("[INFO]["+(new Date).getTime()+"]pub gmapping pose"),NAV.pubCmdString(NAV.CmdEnum.GamppingPose),console.log("[INFO]["+(new Date).getTime()+"]pub save map"),NAV.pubCmdString(NAV.CmdEnum.SaveMap)},saveMapEdit:function(){console.log("[INFO]["+(new Date).getTime()+"]pub load map"),NAV.pubCmdString(NAV.CmdEnum.LoadMap),setTimeout(function(){console.log("[INFO]["+(new Date).getTime()+"]pub save map edit"),NAV.pubCmdString(NAV.CmdEnum.SaveMapEdit)},2e3)},addWaypoint:function(e){var s={close_enough:e.close_enough,goal_timeout:e.goal_timeout,failure_mode:e.failure_mode,type:e.type};e.frame_id&&(s.frame_id=e.frame_id),-1===PARAMS.NeedPoseTypes.indexOf(e.type)&&(e.pose={position:{x:0,y:0,z:0},orientation:{x:0,y:0,z:0,w:0}}),e.mark&&(s.mark=e.mark);var t=JSON.stringify(s),a=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/waypoint_add"),messageType:"yocs_msgs/Waypoint"}),o=new ROSLIB.Message({header:{frame_id:t},close_enough:e.close_enough,goal_timeout:e.goal_timeout,failure_mode:e.failure_mode,name:e.name,pose:e.pose});a.publish(o),console.log("[INFO]waypoint added")},delWaypoint:function(e){var s=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/waypoint_remove"),messageType:"yocs_msgs/Waypoint"}),t=getWaypointByName(e),a=new ROSLIB.Message(t);s.publish(a)},addTrajectory:function(e,s){for(var t=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/trajectory_add"),messageType:"yocs_msgs/Trajectory"}),a=[],o=0;o<s.length;o++){var n=s[o];a.push(getWaypointByName(n))}var r=new ROSLIB.Message({name:e,waypoints:a});t.publish(r)},delTrajectory:function(e){var s=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/trajectory_remove"),messageType:"yocs_msgs/Trajectory"}),t=getTrajectoryByName(e),a=new ROSLIB.Message(t);s.publish(a)},addWaypointsForDock:function(){for(var e in NAV.WaypointsForDock)if("scanMarker_scan"!==e)NAV.addWaypoint(NAV.WaypointsForDock[e]);else for(var s=9;s>3;s--){var t={};(t=$.extend(t,NAV.WaypointsForDock[e])).name+="_"+s,t.close_enough=.1*s,NAV.addWaypoint(t)}},addTrajForDock:function(){var e=setInterval(function(){0!==DATA.waypointsMsg.waypoints.length&&"timer_sail"===DATA.waypointsMsg.waypoints[DATA.waypointsMsg.waypoints.length-1].name&&(NAV.addTrajectory(NAV.DockingBeginTrajName,NAV.DockingBegin),DATA.dockInitPoseName&&(NAV.DockingEnd[0]=DATA.dockInitPoseName,NAV.addTrajectory(NAV.DockingEndTrajName,NAV.DockingEnd)),clearInterval(e),e=null,console.log("[INFO]trajectories for docking added"))},500)},navCtrl:function(e,s){var t=!1;if(!0===(arguments.length<=2?void 0:arguments[2])&&(t=!0),t||DATA.navCtrlStatus.status===PARAMS.NavCtrlStatus.idling||s!==PARAMS.NavCtrl.start){var a=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/nav_ctrl"),messageType:"yocs_msgs/NavigationControl"}),o=new ROSLIB.Message({goal_name:e,control:s});console.log("[INFO]pub "+e+", "+s),a.publish(o)}else ALERT.warn({title:"导航中",text:"正在执行其他任务，当前命令将被忽略"})},manipulateScene:function(e,s){var t=e+":"+s;NAV.pubCmdString(t)},manualCtrl:function(e){var s=e.linear||0,t=e.angular||0,a=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/cmd_vel"),messageType:"geometry_msgs/Twist"}),o=new ROSLIB.Message({linear:{x:s,y:0,z:0},angular:{x:0,y:0,z:t}});DATA.manualCtrlTimer&&(clearInterval(DATA.manualCtrlTimer),DATA.manualCtrlTimer=null),0!==s||0!==t?DATA.manualCtrlTimer=setInterval(function(){a.publish(o)},200):a.publish(o)},subLastNetworkSetting:function(){new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/rosnodejs/last_network_setting"),messageType:"std_msgs/String"}).subscribe(function(e){DATA.lastNetworkSetting=e})},setNetwork:function(e,s){var t=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs("/rosnodejs/network_setting"),messageType:"std_msgs/String"});if(e===PARAMS.NetworkMode.ap){o=new ROSLIB.Message({data:""});console.log("[INFO]switch to ap")}else if(e===PARAMS.NetworkMode.wifi){var a="ssid:"+s.ssid+",\n\t\t\t\tpassword: "+s.password+",\n\t\t\t\tip: "+s.ip+",\n\t\t\t\trememberSetting: "+s.rememberSetting,o=new ROSLIB.Message({data:a});console.log("[INFO]switch to wifi: "+s.ssid+", \n\t\t\t\tip: "+s.ip+", rememberSetting: "+s.rememberSetting)}t.publish(o)},update:function(e,s){var t="";switch(e){case UpdateEvent.Type.onlineAuto:return void NAV.pubCmdString(s);case UpdateEvent.Type.offlineAuto:t="/shell_string";break;case UpdateEvent.Type.others.dbparam:t="/system_shell/shell_string";break;case UpdateEvent.Type.others.openssh:t="/shell_string";break;default:return void console.error("[ERROR]unknown update mode: "+e)}var a=new ROSLIB.Topic({ros:NAV.ros,name:NAV.withNs(t),messageType:"std_msgs/String"}),o=new ROSLIB.Message({data:s});a.publish(o)}};