"use strict";var TF=TF||{quaternionToTheta:function(a){var o=a.w,t=a.x,e=a.y,n=a.z;return 180*-Math.atan2(2*(o*n+t*e),1-2*(e*e+n*n))/Math.PI},quaternionToYaw:function(a,o){var t,e,n=a;return e=o?(t=2*n.w*n.z,1-2*Math.pow(n.z,2)):(t=2*(n.w*n.z+n.x*n.y),1-2*(Math.pow(n.y,2)+Math.pow(n.z,2))),Math.atan2(t,e)},quaternionToRoll:function(a){var o=a,t=2*(o.w*o.x+o.y*o.z),e=1-2*(Math.pow(o.x,2)+Math.pow(o.y,2));return Math.atan2(t,e)},rosToPx:function(a){if(DATA.mapStage){var o=DATA.mapStage.image.height,t=Math.round((a.x-DATA.mapMsg.info.origin.position.x)/DATA.mapMsg.info.resolution*DATA.mapStage.scaleX),e=Math.round((o-(a.y-DATA.mapMsg.info.origin.position.y)/DATA.mapMsg.info.resolution)*DATA.mapStage.scaleY);return{x:t-DATA.mapStage.regX*DATA.mapStage.scaleX,y:e-DATA.mapStage.regY*DATA.mapStage.scaleY}}console.warn("[WARN]map not available")},pxToRos:function(a){var o=DATA.mapStage.image.height;return{x:(a.x+DATA.mapStage.regX*DATA.mapStage.scaleX)*DATA.mapMsg.info.resolution/DATA.mapStage.scaleX+DATA.mapMsg.info.origin.position.x,y:(o-DATA.mapStage.regY-a.y/DATA.mapStage.scaleY)*DATA.mapMsg.info.resolution+DATA.mapMsg.info.origin.position.y}},thetaToQuaternion:function(a){return{x:0,y:0,z:Math.sin(a/2),w:Math.cos(a/2)}},isQuaternionValid:function(a,o){o=o||1e-4;var t=0;for(var e in a)a.hasOwnProperty(e)&&(t+=a[e]*a[e]);return Math.abs(t-1)<o},getTfMat:function(a){var o=a.translation,t=TF.quaternionToYaw(a.rotation),e=Math.sin(t),n=Math.cos(t),s=o.x,r=o.y;return $M([[n,-e,s],[e,n,r],[0,0,1]])},getDockingBeginPose:function(a,o){var t=TF.quaternionToYaw(a.orientation,!0),e=o*Math.cos(t),n=o*Math.sin(t);return a.position.x-=e,a.position.y-=n,a},localPlanOdomToMap:function(a){var o={poses:[]};if(!DATA.tfMsg.map2odom)return console.warn("[WARN]No Tf msg from map to odom available"),o;if(!isTfValid(DATA.tfMsg.map2odom.header.stamp,a.header.stamp,2))return console.warn("[WARN]Tf msg from map to odom out of date"),o;for(var t=TF.getTfMat(DATA.tfMsg.map2odom.transform),e=0;e<a.poses.length;e++){var n=$V([a.poses[e].pose.position.x,a.poses[e].pose.position.y,1]),s=t.multiply(n),r={pose:{position:{x:s.elements[0],y:s.elements[1]}}};o.poses.push(r)}return o},footprintOdomToMap:function(a){var o={polygon:{points:[]}};if(!DATA.tfMsg.map2odom)return console.warn("[WARN]No Tf msg from map to odom available"),o;if(!isTfValid(DATA.tfMsg.map2odom.header.stamp,a.header.stamp,2))return console.warn("[WARN]Tf msg from map to odom out of date"),o;for(var t=TF.getTfMat(DATA.tfMsg.map2odom.transform),e=0;e<a.polygon.points.length;e++){var n=$V([a.polygon.points[e].x,a.polygon.points[e].y,1]),s=t.multiply(n);o.polygon.points.push({x:s.elements[0],y:s.elements[1]})}return o},laserScanBase_laserToMap:function(a){var o=[];if(DATA.tfMsg.hasOwnProperty("map2base_laser"))var t=[DATA.tfMsg.map2base_laser];else t=[DATA.tfMsg.map2odom,DATA.tfMsg.odom2base_footprint,DATA.tfMsg.base_footprint2base_link,DATA.tfMsg.base_link2base_laser];"base_footprint"===DATA.laserScanMsg.header.frame_id&&(t=DATA.tfMsg.hasOwnProperty("map2base_footprint")?[DATA.tfMsg.map2base_footprint]:[DATA.tfMsg.map2odom,DATA.tfMsg.odom2base_footprint]);for(var e=!0,n=0;n<t.length;n++)if(!t[n]){e=!1;break}if(!e)return console.warn("[WARN]One or more Tf msg from map to base_laser not available"),o;var s=!0;for(n=0;n<t.length;n++)s=s&&isTfValid(t[n].header.stamp,a.header.stamp,2);if(!s)return console.warn("[WARN]One or more Tf msg from map to base_laser out of date"),o;var r=$M([[1,0,0],[0,1,0],[0,0,1]]);for(n=0;n<t.length;n++)r=r.multiply(TF.getTfMat(t[n].transform));if(DATA.tfMsg.base_link2base_laser)var i=isLaserUpsideDown(DATA.tfMsg.base_link2base_laser.transform.rotation);else i=0;for(n=0;n<a.ranges.length;n+=10)if(!("inf"===a.ranges[n]||a.ranges[n]<a.range_min||a.ranges[n]>a.range_max)){var p=a.angle_min+a.angle_increment*n,m=[a.ranges[n]*Math.cos(p),a.ranges[n]*Math.sin(p)*Math.pow(-1,i),1],f=$V(m),A=r.multiply(f);o.push({x:A.elements[0],y:A.elements[1]})}return o}};function isTfValid(a,o,t){return!a||Math.abs(a.secs-o.secs)+Math.abs(a.nsecs-o.nsecs)/Math.pow(10,9)<t}function isLaserUpsideDown(a){var o=TF.quaternionToRoll(a);return Math.abs(o-Math.PI)<.01?1:0}